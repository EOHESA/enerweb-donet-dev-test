/**
 * @fileoverview added by tsickle
 * Generated from: lib/directives/validation.directive.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { ChangeDetectorRef, ComponentFactoryResolver, ComponentRef, Directive, Injector, Input, Optional, Renderer2, Self, SkipSelf, TemplateRef, ViewContainerRef, } from '@angular/core';
import { NgControl } from '@angular/forms';
import { merge, NEVER, Subscription } from 'rxjs';
import { filter, map, mapTo } from 'rxjs/operators';
import { AbstractValidationDirective } from '../abstracts';
import { generateValidationError } from '../utils';
import { ValidationGroupDirective } from './validation-group.directive';
import { ValidationStyleDirective } from './validation-style.directive';
import { ValidationTargetDirective } from './validation-target.directive';
var ValidationDirective = /** @class */ (function (_super) {
    tslib_1.__extends(ValidationDirective, _super);
    function ValidationDirective(injector, cdRef, cfRes, control, renderer, vcRef, parentRef, markRef, targetRef) {
        var _this = _super.call(this, injector) || this;
        _this.injector = injector;
        _this.cdRef = cdRef;
        _this.cfRes = cfRes;
        _this.control = control;
        _this.renderer = renderer;
        _this.vcRef = vcRef;
        _this.parentRef = parentRef;
        _this.markRef = markRef;
        _this.targetRef = targetRef;
        _this.subscriptions = new Subscription();
        return _this;
    }
    Object.defineProperty(ValidationDirective.prototype, "validation$", {
        get: /**
         * @return {?}
         */
        function () {
            return merge(this.parent.getStream('status').pipe(mapTo(null)), this.parent.getStream('value').pipe(mapTo(null)), this.validateOnSubmit ? this.parent.getStream('submit') : NEVER);
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @private
     * @param {?} errors
     * @return {?}
     */
    ValidationDirective.prototype.buildErrors = /**
     * @private
     * @param {?} errors
     * @return {?}
     */
    function (errors) {
        var _this = this;
        return Object.keys(errors || {}).map((/**
         * @param {?} key
         * @return {?}
         */
        function (key) {
            return generateValidationError(key, errors[key], _this.blueprints[key]);
        }));
    };
    /**
     * @private
     * @param {?} errors
     * @return {?}
     */
    ValidationDirective.prototype.insertErrors = /**
     * @private
     * @param {?} errors
     * @return {?}
     */
    function (errors) {
        /** @type {?} */
        var template = this.errorTemplate;
        /** @type {?} */
        var vcRef = this.targetRef ? this.targetRef.vcRef : this.vcRef;
        this.errorRef =
            template instanceof TemplateRef
                ? vcRef.createEmbeddedView(template, { $implicit: errors }, vcRef.length)
                : vcRef.createComponent(this.cfRes.resolveComponentFactory(template), vcRef.length, this.injector);
        if (this.errorRef instanceof ComponentRef && this.errorRef.instance)
            ((/** @type {?} */ (this.errorRef))).instance.validationErrors = errors;
    };
    /**
     * @private
     * @return {?}
     */
    ValidationDirective.prototype.removeErrors = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.errorRef) {
            this.errorRef.destroy();
            this.errorRef = null;
        }
    };
    /**
     * @private
     * @return {?}
     */
    ValidationDirective.prototype.setMarkElement = /**
     * @private
     * @return {?}
     */
    function () {
        this.markElement =
            (this.markRef
                ? this.markRef.elRef.nativeElement
                : this.targetSelector
                    ? this.elRef.nativeElement.closest(this.targetSelector)
                    : null) || this.elRef.nativeElement;
    };
    /**
     * @private
     * @return {?}
     */
    ValidationDirective.prototype.subscribeToValidation = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var cached;
        this.subscriptions.add(this.validation$
            .pipe(filter((/**
         * @return {?}
         */
        function () { return !_this.skipValidation; })), map((/**
         * @param {?} form
         * @return {?}
         */
        function (form) { return ({
            errors: _this.mapErrorsFn(_this.buildErrors(_this.control.errors), _this.buildErrors(_this.parentRef.group.errors), _this.control),
            form: form,
        }); })))
            .subscribe((/**
         * @param {?} __0
         * @return {?}
         */
        function (_a) {
            var errors = _a.errors, form = _a.form;
            if (cached === JSON.stringify(errors))
                return;
            _this.removeErrors();
            if (errors.length && (_this.control.dirty || form)) {
                _this.insertErrors(errors);
                _this.renderer.addClass(_this.markElement, _this.invalidClasses);
                cached = JSON.stringify(errors);
            }
            else {
                _this.renderer.removeClass(_this.markElement, _this.invalidClasses);
                cached = '';
            }
            _this.cdRef.markForCheck();
        })));
    };
    /**
     * @return {?}
     */
    ValidationDirective.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        this.setMarkElement();
        this.subscribeToValidation();
    };
    /**
     * @return {?}
     */
    ValidationDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.subscriptions.unsubscribe();
    };
    ValidationDirective.decorators = [
        { type: Directive, args: [{
                    /* tslint:disable-next-line */
                    selector: '[formControl],[formControlName]',
                },] }
    ];
    /** @nocollapse */
    ValidationDirective.ctorParameters = function () { return [
        { type: Injector },
        { type: ChangeDetectorRef },
        { type: ComponentFactoryResolver },
        { type: NgControl, decorators: [{ type: Self }] },
        { type: Renderer2 },
        { type: ViewContainerRef },
        { type: ValidationGroupDirective, decorators: [{ type: SkipSelf }] },
        { type: ValidationStyleDirective, decorators: [{ type: Optional }, { type: SkipSelf }] },
        { type: ValidationTargetDirective, decorators: [{ type: Optional }, { type: SkipSelf }] }
    ]; };
    ValidationDirective.propDecorators = {
        _blueprints: [{ type: Input, args: ['blueprints',] }],
        _errorTemplate: [{ type: Input, args: ['errorTemplate',] }],
        _invalidClasses: [{ type: Input, args: ['invalidClasses',] }],
        _mapErrorsFn: [{ type: Input, args: ['mapErrorsFn',] }],
        _skipValidation: [{ type: Input, args: ['skipValidation',] }],
        _targetSelector: [{ type: Input, args: ['targetSelector',] }],
        _validateOnSubmit: [{ type: Input, args: ['validateOnSubmit',] }]
    };
    return ValidationDirective;
}(AbstractValidationDirective));
export { ValidationDirective };
if (false) {
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.errorRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.markElement;
    /** @type {?} */
    ValidationDirective.prototype._blueprints;
    /** @type {?} */
    ValidationDirective.prototype._errorTemplate;
    /** @type {?} */
    ValidationDirective.prototype._invalidClasses;
    /** @type {?} */
    ValidationDirective.prototype._mapErrorsFn;
    /** @type {?} */
    ValidationDirective.prototype._skipValidation;
    /** @type {?} */
    ValidationDirective.prototype._targetSelector;
    /** @type {?} */
    ValidationDirective.prototype._validateOnSubmit;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.subscriptions;
    /** @type {?} */
    ValidationDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.cdRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.cfRes;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.control;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.renderer;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.vcRef;
    /** @type {?} */
    ValidationDirective.prototype.parentRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.markRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.targetRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGlvbi5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abmd4LXZhbGlkYXRlL2NvcmUvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy92YWxpZGF0aW9uLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxPQUFPLEVBRUwsaUJBQWlCLEVBQ2pCLHdCQUF3QixFQUN4QixZQUFZLEVBQ1osU0FBUyxFQUVULFFBQVEsRUFDUixLQUFLLEVBRUwsUUFBUSxFQUNSLFNBQVMsRUFDVCxJQUFJLEVBQ0osUUFBUSxFQUNSLFdBQVcsRUFFWCxnQkFBZ0IsR0FDakIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFhLFNBQVMsRUFBb0IsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4RSxPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBYyxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDOUQsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDcEQsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sY0FBYyxDQUFDO0FBRzNELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUN4RSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUN4RSxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUUxRTtJQUl5QywrQ0FBMkI7SUFvQ2xFLDZCQUNTLFFBQWtCLEVBQ2pCLEtBQXdCLEVBQ3hCLEtBQStCLEVBRS9CLE9BQWtCLEVBQ2xCLFFBQW1CLEVBQ25CLEtBQXVCLEVBRXhCLFNBQW1DLEVBR2xDLE9BQWlDLEVBR2pDLFNBQW9DO1FBZjlDLFlBaUJFLGtCQUFNLFFBQVEsQ0FBQyxTQUNoQjtRQWpCUSxjQUFRLEdBQVIs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dUNBQWdGOzs7OztJQUNoRiwwQ0FBaUM7O0lBRWpDLDBDQUNtQzs7SUFFbkMsNkNBQzZDOztJQUU3Qyw4Q0FDd0I7O0lBRXhCLDJDQUNxQzs7SUFFckMsOENBQ3lCOztJQUV6Qiw4Q0FDd0I7O0lBRXhCLGdEQUMyQjs7Ozs7SUFVM0IsNENBQTJDOztJQUd6Qyx1Q0FBeUI7Ozs7O0lBQ3pCLG9DQUFnQzs7Ozs7SUFDaEMsb0NBQXVDOzs7OztJQUN2QyxzQ0FDMEI7Ozs7O0lBQzFCLHVDQUEyQjs7Ozs7SUFDM0Isb0NBQStCOztJQUMvQix3Q0FDMEM7Ozs7O0lBQzFDLHNDQUV5Qzs7Ozs7SUFDekMsd0NBRTRDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgQ29tcG9uZW50UmVmLFxuICBEaXJlY3RpdmUsXG4gIEVtYmVkZGVkVmlld1JlZixcbiAgSW5qZWN0b3IsXG4gIElucHV0LFxuICBPbkRlc3Ryb3ksXG4gIE9wdGlvbmFsLFxuICBSZW5kZXJlcjIsXG4gIFNlbGYsXG4gIFNraXBTZWxmLFxuICBUZW1wbGF0ZVJlZixcbiAgVHlwZSxcbiAgVmlld0NvbnRhaW5lclJlZixcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGb3JtR3JvdXAsIE5nQ29udHJvbCwgVmFsaWRhdGlvbkVycm9ycyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IG1lcmdlLCBORVZFUiwgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIG1hcCwgbWFwVG8gfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBBYnN0cmFjdFZhbGlkYXRpb25EaXJlY3RpdmUgfSBmcm9tICcuLi9hYnN0cmFjdHMnO1xuaW1wb3J0IHsgVmFsaWRhdGlvbkVycm9yQ29tcG9uZW50IH0gZnJvbSAnLi4vY29tcG9uZW50cyc7XG5pbXBvcnQgeyBWYWxpZGF0aW9uIH0gZnJvbSAnLi4vbW9kZWxzJztcbmltcG9ydCB7IGdlbmVyYXRlVmFsaWRhdGlvbkVycm9yIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgVmFsaWRhdGlvbkdyb3VwRGlyZWN0aXZlIH0gZnJvbSAnLi92YWxpZGF0aW9uLWdyb3VwLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBWYWxpZGF0aW9uU3R5bGVEaXJlY3RpdmUgfSBmcm9tICcuL3ZhbGlkYXRpb24tc3R5bGUuZGlyZWN0aXZlJztcbmltcG9ydCB7IFZhbGlkYXRpb25UYXJnZXREaXJlY3RpdmUgfSBmcm9tICcuL3ZhbGlkYXRpb24tdGFyZ2V0LmRpcmVjdGl2ZSc7XG5cbkBEaXJlY3RpdmUoe1xuICAvKiB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmUgKi9cbiAgc2VsZWN0b3I6ICdbZm9ybUNvbnRyb2xdLFtmb3JtQ29udHJvbE5hbWVdJyxcbn0pXG5leHBvcnQgY2xhc3MgVmFsaWRhdGlvbkRpcmVjdGl2ZSBleHRlbmRzIEFic3RyYWN0VmFsaWRhdGlvbkRpcmVjdGl2ZVxuICBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSB7XG4gIHByaXZhdGUgZXJyb3JSZWY6IENvbXBvbmVudFJlZjxWYWxpZGF0aW9uRXJyb3JDb21wb25lbnQ+IHwgRW1iZWRkZWRWaWV3UmVmPGFueT47XG4gIHByaXZhdGUgbWFya0VsZW1lbnQ6IEhUTUxFbGVtZW50O1xuXG4gIEBJbnB1dCgnYmx1ZXByaW50cycpXG4gIF9ibHVlcHJpbnRzOiBWYWxpZGF0aW9uLkJsdWVwcmludHM7XG5cbiAgQElucHV0KCdlcnJvclRlbXBsYXRlJylcbiAgX2Vycm9yVGVtcGxhdGU6IFRlbXBsYXRlUmVmPGFueT4gfCBUeXBlPGFueT47XG5cbiAgQElucHV0KCdpbnZhbGlkQ2xhc3NlcycpXG4gIF9pbnZhbGlkQ2xhc3Nlczogc3RyaW5nO1xuXG4gIEBJbnB1dCgnbWFwRXJyb3JzRm4nKVxuICBfbWFwRXJyb3JzRm46IFZhbGlkYXRpb24uTWFwRXJyb3JzRm47XG5cbiAgQElucHV0KCdza2lwVmFsaWRhdGlvbicpXG4gIF9za2lwVmFsaWRhdGlvbjogYm9vbGVhbjtcblxuICBASW5wdXQoJ3RhcmdldFNlbGVjdG9yJylcbiAgX3RhcmdldFNlbGVjdG9yOiBzdHJpbmc7XG5cbiAgQElucHV0KCd2YWxpZGF0ZU9uU3VibWl0JylcbiAgX3ZhbGlkYXRlT25TdWJtaXQ6IGJvb2xlYW47XG5cbiAgZ2V0IHZhbGlkYXRpb24kKCk6IE9ic2VydmFibGU8Rm9ybUdyb3VwPiB7XG4gICAgcmV0dXJuIG1lcmdlKFxuICAgICAgdGhpcy5wYXJlbnQuZ2V0U3RyZWFtKCdzdGF0dXMnKS5waXBlKG1hcFRvKG51bGwpKSxcbiAgICAgIHRoaXMucGFyZW50LmdldFN0cmVhbSgndmFsdWUnKS5waXBlKG1hcFRvKG51bGwpKSxcbiAgICAgIHRoaXMudmFsaWRhdGVPblN1Ym1pdCA/IHRoaXMucGFyZW50LmdldFN0cmVhbSgnc3VibWl0JykgOiBORVZFUixcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb25zID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgcHJpdmF0ZSBjZFJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgcHJpdmF0ZSBjZlJlczogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgIEBTZWxmKClcbiAgICBwcml2YXRlIGNvbnRyb2w6IE5nQ29udHJvbCxcbiAgICBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICAgcHJpdmF0ZSB2Y1JlZjogVmlld0NvbnRhaW5lclJlZixcbiAgICBAU2tpcFNlbGYoKVxuICAgIHB1YmxpYyBwYXJlbnRSZWY6IFZhbGlkYXRpb25Hcm91cERpcmVjdGl2ZSxcbiAgICBAT3B0aW9uYWwoKVxuICAgIEBTa2lwU2VsZigpXG4gICAgcHJpdmF0ZSBtYXJrUmVmOiBWYWxpZGF0aW9uU3R5bGVEaXJlY3RpdmUsXG4gICAgQE9wdGlvbmFsKClcbiAgICBAU2tpcFNlbGYoKVxuICAgIHByaXZhdGUgdGFyZ2V0UmVmOiBWYWxpZGF0aW9uVGFyZ2V0RGlyZWN0aXZlLFxuICApIHtcbiAgICBzdXBlcihpbmplY3Rvcik7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkRXJyb3JzKGVycm9yczogVmFsaWRhdGlvbkVycm9ycyk6IFZhbGlkYXRpb24uRXJyb3JbXSB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKGVycm9ycyB8fCB7fSkubWFwKGtleSA9PlxuICAgICAgZ2VuZXJhdGVWYWxpZGF0aW9uRXJyb3Ioa2V5LCBlcnJvcnNba2V5XSwgdGhpcy5ibHVlcHJpbnRzW2tleV0pLFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGluc2VydEVycm9ycyhlcnJvcnM6IFZhbGlkYXRpb24uRXJyb3JbXSk6IHZvaWQge1xuICAgIGNvbnN0IHRlbXBsYXRlID0gdGhpcy5lcnJvclRlbXBsYXRlO1xuICAgIGNvbnN0IHZjUmVmID0gdGhpcy50YXJnZXRSZWYgPyB0aGlzLnRhcmdldFJlZi52Y1JlZiA6IHRoaXMudmNSZWY7XG5cbiAgICB0aGlzLmVycm9yUmVmID1cbiAgICAgIHRlbXBsYXRlIGluc3RhbmNlb2YgVGVtcGxhdGVSZWZcbiAgICAgICAgPyB2Y1JlZi5jcmVhdGVFbWJlZGRlZFZpZXcodGVtcGxhdGUsIHsgJGltcGxpY2l0OiBlcnJvcnMgfSwgdmNSZWYubGVuZ3RoKVxuICAgICAgICA6IHZjUmVmLmNyZWF0ZUNvbXBvbmVudChcbiAgICAgICAgICAgIHRoaXMuY2ZSZXMucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkodGVtcGxhdGUpLFxuICAgICAgICAgICAgdmNSZWYubGVuZ3RoLFxuICAgICAgICAgICAgdGhpcy5pbmplY3RvcixcbiAgICAgICAgICApO1xuXG4gICAgaWYgKHRoaXMuZXJyb3JSZWYgaW5zdGFuY2VvZiBDb21wb25lbnRSZWYgJiYgdGhpcy5lcnJvclJlZi5pbnN0YW5jZSlcbiAgICAgICh0aGlzLmVycm9yUmVmIGFzIENvbXBvbmVudFJlZjxhbnk+KS5pbnN0YW5jZS52YWxpZGF0aW9uRXJyb3JzID0gZXJyb3JzO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVFcnJvcnMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZXJyb3JSZWYpIHtcbiAgICAgIHRoaXMuZXJyb3JSZWYuZGVzdHJveSgpO1xuICAgICAgdGhpcy5lcnJvclJlZiA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRNYXJrRWxlbWVudCgpOiB2b2lkIHtcbiAgICB0aGlzLm1hcmtFbGVtZW50ID1cbiAgICAgICh0aGlzLm1hcmtSZWZcbiAgICAgICAgPyB0aGlzLm1hcmtSZWYuZWxSZWYubmF0aXZlRWxlbWVudFxuICAgICAgICA6IHRoaXMudGFyZ2V0U2VsZWN0b3JcbiAgICAgICAgPyB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQuY2xvc2VzdCh0aGlzLnRhcmdldFNlbGVjdG9yKVxuICAgICAgICA6IG51bGwpIHx8IHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudDtcbiAgfVxuXG4gIHByaXZhdGUgc3Vic2NyaWJlVG9WYWxpZGF0aW9uKCk6IHZvaWQge1xuICAgIGxldCBjYWNoZWQ6IHN0cmluZztcblxuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5hZGQoXG4gICAgICB0aGlzLnZhbGlkYXRpb24kXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgIGZpbHRlcigoKSA9PiAhdGhpcy5za2lwVmFsaWRhdGlvbiksXG4gICAgICAgICAgbWFwKGZvcm0gPT4gKHtcbiAgICAgICAgICAgIGVycm9yczogdGhpcy5tYXBFcnJvcnNGbihcbiAgICAgICAgICAgICAgdGhpcy5idWlsZEVycm9ycyh0aGlzLmNvbnRyb2wuZXJyb3JzKSxcbiAgICAgICAgICAgICAgdGhpcy5idWlsZEVycm9ycyh0aGlzLnBhcmVudFJlZi5ncm91cC5lcnJvcnMpLFxuICAgICAgICAgICAgICB0aGlzLmNvbnRyb2wsXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgZm9ybSxcbiAgICAgICAgICB9KSksXG4gICAgICAgIClcbiAgICAgICAgLnN1YnNjcmliZSgoeyBlcnJvcnMsIGZvcm0gfSkgPT4ge1xuICAgICAgICAgIGlmIChjYWNoZWQgPT09IEpTT04uc3RyaW5naWZ5KGVycm9ycykpIHJldHVybjtcblxuICAgICAgICAgIHRoaXMucmVtb3ZlRXJyb3JzKCk7XG5cbiAgICAgICAgICBpZiAoZXJyb3JzLmxlbmd0aCAmJiAodGhpcy5jb250cm9sLmRpcnR5IHx8IGZvcm0pKSB7XG4gICAgICAgICAgICB0aGlzLmluc2VydEVycm9ycyhlcnJvcnMpO1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyh0aGlzLm1hcmtFbGVtZW50LCB0aGlzLmludmFsaWRDbGFzc2VzKTtcbiAgICAgICAgICAgIGNhY2hlZCA9IEpTT04uc3RyaW5naWZ5KGVycm9ycyk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2xhc3ModGhpcy5tYXJrRWxlbWVudCwgdGhpcy5pbnZhbGlkQ2xhc3Nlcyk7XG4gICAgICAgICAgICBjYWNoZWQgPSAnJztcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB0aGlzLmNkUmVmLm1hcmtGb3JDaGVjaygpO1xuICAgICAgICB9KSxcbiAgICApO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIHRoaXMuc2V0TWFya0VsZW1lbnQoKTtcbiAgICB0aGlzLnN1YnNjcmliZVRvVmFsaWRhdGlvbigpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLnVuc3Vic2NyaWJlKCk7XG4gIH1cbn1cbiJdfQ==