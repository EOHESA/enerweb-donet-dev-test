/**
 * @fileoverview added by tsickle
 * Generated from: lib/directives/validation.directive.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChangeDetectorRef, ComponentFactoryResolver, ComponentRef, Directive, Injector, Input, Optional, Renderer2, Self, SkipSelf, TemplateRef, ViewContainerRef, } from '@angular/core';
import { NgControl } from '@angular/forms';
import { merge, NEVER, Subscription } from 'rxjs';
import { filter, map, mapTo } from 'rxjs/operators';
import { AbstractValidationDirective } from '../abstracts';
import { generateValidationError } from '../utils';
import { ValidationGroupDirective } from './validation-group.directive';
import { ValidationStyleDirective } from './validation-style.directive';
import { ValidationTargetDirective } from './validation-target.directive';
export class ValidationDirective extends AbstractValidationDirective {
    /**
     * @param {?} injector
     * @param {?} cdRef
     * @param {?} cfRes
     * @param {?} control
     * @param {?} renderer
     * @param {?} vcRef
     * @param {?} parentRef
     * @param {?} markRef
     * @param {?} targetRef
     */
    constructor(injector, cdRef, cfRes, control, renderer, vcRef, parentRef, markRef, targetRef) {
        super(injector);
        this.injector = injector;
        this.cdRef = cdRef;
        this.cfRes = cfRes;
        this.control = control;
        this.renderer = renderer;
        this.vcRef = vcRef;
        this.parentRef = parentRef;
        this.markRef = markRef;
        this.targetRef = targetRef;
        this.subscriptions = new Subscription();
    }
    /**
     * @return {?}
     */
    get validation$() {
        return merge(this.parent.getStream('status').pipe(mapTo(null)), this.parent.getStream('value').pipe(mapTo(null)), this.validateOnSubmit ? this.parent.getStream('submit') : NEVER);
    }
    /**
     * @private
     * @param {?} errors
     * @return {?}
     */
    buildErrors(errors) {
        return Object.keys(errors || {}).map((/**
         * @param {?} key
         * @return {?}
         */
        key => generateValidationError(key, errors[key], this.blueprints[key])));
    }
    /**
     * @private
     * @param {?} errors
     * @return {?}
     */
    insertErrors(errors) {
        /** @type {?} */
        const template = this.errorTemplate;
        /** @type {?} */
        const vcRef = this.targetRef ? this.targetRef.vcRef : this.vcRef;
        this.errorRef =
            template instanceof TemplateRef
                ? vcRef.createEmbeddedView(template, { $implicit: errors }, vcRef.length)
                : vcRef.createComponent(this.cfRes.resolveComponentFactory(template), vcRef.length, this.injector);
        if (this.errorRef instanceof ComponentRef && this.errorRef.instance)
            ((/** @type {?} */ (this.errorRef))).instance.validationErrors = errors;
    }
    /**
     * @private
     * @return {?}
     */
    removeErrors() {
        if (this.errorRef) {
            this.errorRef.destroy();
            this.errorRef = null;
        }
    }
    /**
     * @private
     * @return {?}
     */
    setMarkElement() {
        this.markElement =
            (this.markRef
                ? this.markRef.elRef.nativeElement
                : this.targetSelector
                    ? this.elRef.nativeElement.closest(this.targetSelector)
                    : null) || this.elRef.nativeElement;
    }
    /**
     * @private
     * @return {?}
     */
    subscribeToValidation() {
        /** @type {?} */
        let cached;
        this.subscriptions.add(this.validation$
            .pipe(filter((/**
         * @return {?}
         */
        () => !this.skipValidation)), map((/**
         * @param {?} form
         * @return {?}
         */
        form => ({
            errors: this.mapErrorsFn(this.buildErrors(this.control.errors), this.buildErrors(this.parentRef.group.errors), this.control),
            form,
        }))))
            .subscribe((/**
         * @param {?} __0
         * @return {?}
         */
        ({ errors, form }) => {
            if (cached === JSON.stringify(errors))
                return;
            this.removeErrors();
            if (errors.length && (this.control.dirty || form)) {
                this.insertErrors(errors);
                this.renderer.addClass(this.markElement, this.invalidClasses);
                cached = JSON.stringify(errors);
            }
            else {
                this.renderer.removeClass(this.markElement, this.invalidClasses);
                cached = '';
            }
            this.cdRef.markForCheck();
        })));
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.setMarkElement();
        this.subscribeToValidation();
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.subscriptions.unsubscribe();
    }
}
ValidationDirective.decorators = [
    { type: Directive, args: [{
                /* tslint:disable-next-line */
                selector: '[formControl],[formControlName]',
            },] }
];
/** @nocollapse */
ValidationDirective.ctorParameters = () => [
    { type: Injector },
    { type: ChangeDetectorRef },
    { type: ComponentFactoryResolver },
    { type: NgControl, decorators: [{ type: Self }] },
    { type: Renderer2 },
    { type: ViewContainerRef },
    { type: ValidationGroupDirective, decorators: [{ type: SkipSelf }] },
    { type: ValidationStyleDirective, decorators: [{ type: Optional }, { type: SkipSelf }] },
    { type: ValidationTargetDirective, decorators: [{ type: Optional }, { type: SkipSelf }] }
];
ValidationDirective.propDecorators = {
    _blueprints: [{ type: Input, args: ['blueprints',] }],
    _errorTemplate: [{ type: Input, args: ['errorTemplate',] }],
    _invalidClasses: [{ type: Input, args: ['invalidClasses',] }],
    _mapErrorsFn: [{ type: Input, args: ['mapErrorsFn',] }],
    _skipValidation: [{ type: Input, args: ['skipValidation',] }],
    _targetSelector: [{ type: Input, args: ['targetSelector',] }],
    _validateOnSubmit: [{ type: Input, args: ['validateOnSubmit',] }]
};
if (false) {
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.errorRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.markElement;
    /** @type {?} */
    ValidationDirective.prototype._blueprints;
    /** @type {?} */
    ValidationDirective.prototype._errorTemplate;
    /** @type {?} */
    ValidationDirective.prototype._invalidClasses;
    /** @type {?} */
    ValidationDirective.prototype._mapErrorsFn;
    /** @type {?} */
    ValidationDirective.prototype._skipValidation;
    /** @type {?} */
    ValidationDirective.prototype._targetSelector;
    /** @type {?} */
    ValidationDirective.prototype._validateOnSubmit;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.subscriptions;
    /** @type {?} */
    ValidationDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.cdRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.cfRes;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.control;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.renderer;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.vcRef;
    /** @type {?} */
    ValidationDirective.prototype.parentRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.markRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.targetRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGlvbi5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abmd4LXZhbGlkYXRlL2NvcmUvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy92YWxpZGF0aW9uLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFFTCxpQkFBaUIsRUFDakIsd0JBQXdCLEVBQ3hCLFlBQVksRUFDWixTQUFTLEVBRVQsUUFBUSxFQUNSLEtBQUssRUFFTCxRQUFRLEVBQ1IsU0FBUyxFQUNULElBQUksRUFDSixRQUFRLEVBQ1IsV0FBVyxFQUVYLGdCQUFnQixHQUNqQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQWEsU0FBUyxFQUFvQixNQUFNLGdCQUFnQixDQUFDO0FBQ3hFLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFjLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5RCxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFHM0QsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ25ELE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ3hFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ3hFLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBTTFFLE1BQU0sT0FBTyxtQkFBb0IsU0FBUSwyQkFBMkI7Ozs7Ozs7Ozs7OztJQW9DbEUsWUFDUyxRQUFrQixFQUNqQixLQUF3QixFQUN4QixLQUErQixFQUUvQixPQUFrQixFQUNsQixRQUFtQixFQUNuQixLQUF1QixFQUV4QixTQUFtQyxFQUdsQyxPQUFpQyxFQUdqQyxTQUFvQztRQUU1QyxLQUFLLENBQUMsUUFBUSxDQUFD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Q2hDLG9DQUF1Qzs7Ozs7SUFDdkMsc0NBQzBCOzs7OztJQUMxQix1Q0FBMkI7Ozs7O0lBQzNCLG9DQUErQjs7SUFDL0Isd0NBQzBDOzs7OztJQUMxQyxzQ0FFeUM7Ozs7O0lBQ3pDLHdDQUU0QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFmdGVyVmlld0luaXQsXG4gIENoYW5nZURldGVjdG9yUmVmLFxuICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gIENvbXBvbmVudFJlZixcbiAgRGlyZWN0aXZlLFxuICBFbWJlZGRlZFZpZXdSZWYsXG4gIEluamVjdG9yLFxuICBJbnB1dCxcbiAgT25EZXN0cm95LFxuICBPcHRpb25hbCxcbiAgUmVuZGVyZXIyLFxuICBTZWxmLFxuICBTa2lwU2VsZixcbiAgVGVtcGxhdGVSZWYsXG4gIFR5cGUsXG4gIFZpZXdDb250YWluZXJSZWYsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRm9ybUdyb3VwLCBOZ0NvbnRyb2wsIFZhbGlkYXRpb25FcnJvcnMgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBtZXJnZSwgTkVWRVIsIE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBtYXAsIG1hcFRvIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQWJzdHJhY3RWYWxpZGF0aW9uRGlyZWN0aXZlIH0gZnJvbSAnLi4vYWJzdHJhY3RzJztcbmltcG9ydCB7IFZhbGlkYXRpb25FcnJvckNvbXBvbmVudCB9IGZyb20gJy4uL2NvbXBvbmVudHMnO1xuaW1wb3J0IHsgVmFsaWRhdGlvbiB9IGZyb20gJy4uL21vZGVscyc7XG5pbXBvcnQgeyBnZW5lcmF0ZVZhbGlkYXRpb25FcnJvciB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IFZhbGlkYXRpb25Hcm91cERpcmVjdGl2ZSB9IGZyb20gJy4vdmFsaWRhdGlvbi1ncm91cC5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgVmFsaWRhdGlvblN0eWxlRGlyZWN0aXZlIH0gZnJvbSAnLi92YWxpZGF0aW9uLXN0eWxlLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBWYWxpZGF0aW9uVGFyZ2V0RGlyZWN0aXZlIH0gZnJvbSAnLi92YWxpZGF0aW9uLXRhcmdldC5kaXJlY3RpdmUnO1xuXG5ARGlyZWN0aXZlKHtcbiAgLyogdHNsaW50OmRpc2FibGUtbmV4dC1saW5lICovXG4gIHNlbGVjdG9yOiAnW2Zvcm1Db250cm9sXSxbZm9ybUNvbnRyb2xOYW1lXScsXG59KVxuZXhwb3J0IGNsYXNzIFZhbGlkYXRpb25EaXJlY3RpdmUgZXh0ZW5kcyBBYnN0cmFjdFZhbGlkYXRpb25EaXJlY3RpdmVcbiAgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xuICBwcml2YXRlIGVycm9yUmVmOiBDb21wb25lbnRSZWY8VmFsaWRhdGlvbkVycm9yQ29tcG9uZW50PiB8IEVtYmVkZGVkVmlld1JlZjxhbnk+O1xuICBwcml2YXRlIG1hcmtFbGVtZW50OiBIVE1MRWxlbWVudDtcblxuICBASW5wdXQoJ2JsdWVwcmludHMnKVxuICBfYmx1ZXByaW50czogVmFsaWRhdGlvbi5CbHVlcHJpbnRzO1xuXG4gIEBJbnB1dCgnZXJyb3JUZW1wbGF0ZScpXG4gIF9lcnJvclRlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+IHwgVHlwZTxhbnk+O1xuXG4gIEBJbnB1dCgnaW52YWxpZENsYXNzZXMnKVxuICBfaW52YWxpZENsYXNzZXM6IHN0cmluZztcblxuICBASW5wdXQoJ21hcEVycm9yc0ZuJylcbiAgX21hcEVycm9yc0ZuOiBWYWxpZGF0aW9uLk1hcEVycm9yc0ZuO1xuXG4gIEBJbnB1dCgnc2tpcFZhbGlkYXRpb24nKVxuICBfc2tpcFZhbGlkYXRpb246IGJvb2xlYW47XG5cbiAgQElucHV0KCd0YXJnZXRTZWxlY3RvcicpXG4gIF90YXJnZXRTZWxlY3Rvcjogc3RyaW5nO1xuXG4gIEBJbnB1dCgndmFsaWRhdGVPblN1Ym1pdCcpXG4gIF92YWxpZGF0ZU9uU3VibWl0OiBib29sZWFuO1xuXG4gIGdldCB2YWxpZGF0aW9uJCgpOiBPYnNlcnZhYmxlPEZvcm1Hcm91cD4ge1xuICAgIHJldHVybiBtZXJnZShcbiAgICAgIHRoaXMucGFyZW50LmdldFN0cmVhbSgnc3RhdHVzJykucGlwZShtYXBUbyhudWxsKSksXG4gICAgICB0aGlzLnBhcmVudC5nZXRTdHJlYW0oJ3ZhbHVlJykucGlwZShtYXBUbyhudWxsKSksXG4gICAgICB0aGlzLnZhbGlkYXRlT25TdWJtaXQgPyB0aGlzLnBhcmVudC5nZXRTdHJlYW0oJ3N1Ym1pdCcpIDogTkVWRVIsXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgc3Vic2NyaXB0aW9ucyA9IG5ldyBTdWJzY3JpcHRpb24oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgaW5qZWN0b3I6IEluamVjdG9yLFxuICAgIHByaXZhdGUgY2RSZWY6IENoYW5nZURldGVjdG9yUmVmLFxuICAgIHByaXZhdGUgY2ZSZXM6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICBAU2VsZigpXG4gICAgcHJpdmF0ZSBjb250cm9sOiBOZ0NvbnRyb2wsXG4gICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxuICAgIHByaXZhdGUgdmNSZWY6IFZpZXdDb250YWluZXJSZWYsXG4gICAgQFNraXBTZWxmKClcbiAgICBwdWJsaWMgcGFyZW50UmVmOiBWYWxpZGF0aW9uR3JvdXBEaXJlY3RpdmUsXG4gICAgQE9wdGlvbmFsKClcbiAgICBAU2tpcFNlbGYoKVxuICAgIHByaXZhdGUgbWFya1JlZjogVmFsaWRhdGlvblN0eWxlRGlyZWN0aXZlLFxuICAgIEBPcHRpb25hbCgpXG4gICAgQFNraXBTZWxmKClcbiAgICBwcml2YXRlIHRhcmdldFJlZjogVmFsaWRhdGlvblRhcmdldERpcmVjdGl2ZSxcbiAgKSB7XG4gICAgc3VwZXIoaW5qZWN0b3IpO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZEVycm9ycyhlcnJvcnM6IFZhbGlkYXRpb25FcnJvcnMpOiBWYWxpZGF0aW9uLkVycm9yW10ge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyhlcnJvcnMgfHwge30pLm1hcChrZXkgPT5cbiAgICAgIGdlbmVyYXRlVmFsaWRhdGlvbkVycm9yKGtleSwgZXJyb3JzW2tleV0sIHRoaXMuYmx1ZXByaW50c1trZXldKSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBpbnNlcnRFcnJvcnMoZXJyb3JzOiBWYWxpZGF0aW9uLkVycm9yW10pOiB2b2lkIHtcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IHRoaXMuZXJyb3JUZW1wbGF0ZTtcbiAgICBjb25zdCB2Y1JlZiA9IHRoaXMudGFyZ2V0UmVmID8gdGhpcy50YXJnZXRSZWYudmNSZWYgOiB0aGlzLnZjUmVmO1xuXG4gICAgdGhpcy5lcnJvclJlZiA9XG4gICAgICB0ZW1wbGF0ZSBpbnN0YW5jZW9mIFRlbXBsYXRlUmVmXG4gICAgICAgID8gdmNSZWYuY3JlYXRlRW1iZWRkZWRWaWV3KHRlbXBsYXRlLCB7ICRpbXBsaWNpdDogZXJyb3JzIH0sIHZjUmVmLmxlbmd0aClcbiAgICAgICAgOiB2Y1JlZi5jcmVhdGVDb21wb25lbnQoXG4gICAgICAgICAgICB0aGlzLmNmUmVzLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KHRlbXBsYXRlKSxcbiAgICAgICAgICAgIHZjUmVmLmxlbmd0aCxcbiAgICAgICAgICAgIHRoaXMuaW5qZWN0b3IsXG4gICAgICAgICAgKTtcblxuICAgIGlmICh0aGlzLmVycm9yUmVmIGluc3RhbmNlb2YgQ29tcG9uZW50UmVmICYmIHRoaXMuZXJyb3JSZWYuaW5zdGFuY2UpXG4gICAgICAodGhpcy5lcnJvclJlZiBhcyBDb21wb25lbnRSZWY8YW55PikuaW5zdGFuY2UudmFsaWRhdGlvbkVycm9ycyA9IGVycm9ycztcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlRXJyb3JzKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmVycm9yUmVmKSB7XG4gICAgICB0aGlzLmVycm9yUmVmLmRlc3Ryb3koKTtcbiAgICAgIHRoaXMuZXJyb3JSZWYgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0TWFya0VsZW1lbnQoKTogdm9pZCB7XG4gICAgdGhpcy5tYXJrRWxlbWVudCA9XG4gICAgICAodGhpcy5tYXJrUmVmXG4gICAgICAgID8gdGhpcy5tYXJrUmVmLmVsUmVmLm5hdGl2ZUVsZW1lbnRcbiAgICAgICAgOiB0aGlzLnRhcmdldFNlbGVjdG9yXG4gICAgICAgID8gdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LmNsb3Nlc3QodGhpcy50YXJnZXRTZWxlY3RvcilcbiAgICAgICAgOiBudWxsKSB8fCB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQ7XG4gIH1cblxuICBwcml2YXRlIHN1YnNjcmliZVRvVmFsaWRhdGlvbigpOiB2b2lkIHtcbiAgICBsZXQgY2FjaGVkOiBzdHJpbmc7XG5cbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKFxuICAgICAgdGhpcy52YWxpZGF0aW9uJFxuICAgICAgICAucGlwZShcbiAgICAgICAgICBmaWx0ZXIoKCkgPT4gIXRoaXMuc2tpcFZhbGlkYXRpb24pLFxuICAgICAgICAgIG1hcChmb3JtID0+ICh7XG4gICAgICAgICAgICBlcnJvcnM6IHRoaXMubWFwRXJyb3JzRm4oXG4gICAgICAgICAgICAgIHRoaXMuYnVpbGRFcnJvcnModGhpcy5jb250cm9sLmVycm9ycyksXG4gICAgICAgICAgICAgIHRoaXMuYnVpbGRFcnJvcnModGhpcy5wYXJlbnRSZWYuZ3JvdXAuZXJyb3JzKSxcbiAgICAgICAgICAgICAgdGhpcy5jb250cm9sLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGZvcm0sXG4gICAgICAgICAgfSkpLFxuICAgICAgICApXG4gICAgICAgIC5zdWJzY3JpYmUoKHsgZXJyb3JzLCBmb3JtIH0pID0+IHtcbiAgICAgICAgICBpZiAoY2FjaGVkID09PSBKU09OLnN0cmluZ2lmeShlcnJvcnMpKSByZXR1cm47XG5cbiAgICAgICAgICB0aGlzLnJlbW92ZUVycm9ycygpO1xuXG4gICAgICAgICAgaWYgKGVycm9ycy5sZW5ndGggJiYgKHRoaXMuY29udHJvbC5kaXJ0eSB8fCBmb3JtKSkge1xuICAgICAgICAgICAgdGhpcy5pbnNlcnRFcnJvcnMoZXJyb3JzKTtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3ModGhpcy5tYXJrRWxlbWVudCwgdGhpcy5pbnZhbGlkQ2xhc3Nlcyk7XG4gICAgICAgICAgICBjYWNoZWQgPSBKU09OLnN0cmluZ2lmeShlcnJvcnMpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKHRoaXMubWFya0VsZW1lbnQsIHRoaXMuaW52YWxpZENsYXNzZXMpO1xuICAgICAgICAgICAgY2FjaGVkID0gJyc7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdGhpcy5jZFJlZi5tYXJrRm9yQ2hlY2soKTtcbiAgICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICB0aGlzLnNldE1hcmtFbGVtZW50KCk7XG4gICAgdGhpcy5zdWJzY3JpYmVUb1ZhbGlkYXRpb24oKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy51bnN1YnNjcmliZSgpO1xuICB9XG59XG4iXX0=